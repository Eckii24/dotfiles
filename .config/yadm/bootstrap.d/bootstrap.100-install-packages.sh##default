#!/bin/bash

set -eu

install_brew_dependencies_on_linux() {
  if [[ "$(uname)" == "Linux" ]]; then
    echo "Install dependencies for Homebrew..."

    if command -v sudo &>/dev/null && sudo -n true 2>/dev/null; then
      sudo apt-get update && sudo apt-get install -y build-essential procps curl file git
    else
      apt-get update && apt-get install -y build-essential procps curl file git
    fi
  fi
}

# Function to add Homebrew to PATH
add_brew_to_path() {
  if [[ -x "/opt/homebrew/bin/brew" ]]; then
    # Apple Silicon (ARM)
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -x "/usr/local/bin/brew" ]]; then
    # Intel Mac
    eval "$(/usr/local/bin/brew shellenv)"
  elif [[ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
    # Linux
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi
}

# Ensure Homebrew is in PATH if it is already installed
add_brew_to_path

# Install Homebrew if not already installed
if ! command -v brew &>/dev/null; then
  install_brew_dependencies_on_linux

  echo "Homebrew not found. Installing Homebrew..."
  export NONINTERACTIVE=1
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  echo "Adding Homebrew to PATH..."
  add_brew_to_path
else
  echo "Homebrew is already installed."
fi

# Install dependencies using Brewfile
if [[ -f "$HOME/.config/yadm/Brewfile" ]]; then
  echo "Installing dependencies from Brewfile..."
  brew bundle --file="$HOME/.config/yadm/Brewfile"
else
  echo "No Brewfile found. Skipping dependency installation."
fi
